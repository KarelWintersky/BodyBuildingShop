<div id="page_cart">

	<?if(count($_POST)>0):?>

		<?if(!$this->registry['f_cart']->delivery_payment_match_check()):?>
			<div id="deilvery_payment_fail" class="common_hint">
				<b>Внимание!</b> Выбрано неверное сочетание способа доставки и способа оплаты.
			</div>

			<div class="cart_hint texted">

				<p>Вы выбрали способ доставки: <b><?=$this->registry['f_cart']->delivery_types[$_POST['order_vals']['delivery']]['name'];?></b><br><br></p>

				<p><b>Возможные варианты оплаты:</b></p>

				<ul>
					<?$this->registry['f_cart']->print_payment_match();?>
				</ul>

				<p><br><br><a href="/cart/order/">Вернитесь на шаг назад</a> и выберите один из представленных выше вариантов оплаты.<br><br></p>

			</div>

			<div class="common_hint">
				Если вы не можете выбрать корректный варинат оплаты по техническим причинам, <a href="/contacts/">свяжитесь с нами</a>, кратко описав проблему в письме, и мы поможем вам сделать заказ в течение 24 часов.
			</div>

			<div class="cart_hint texted">
				<br><br>
				<a href="/cart/order/">« Вернуться на шаг назад</a>
			</div>

		<?else:?>

			<form id="form_cart_2" action="/cart/order/done/" method="POST" onsubmit="cart_check_submit(this);">

				<h1 class="second_style">Оформление заказа</h1>

				<div class="cart_hint">
					Еще раз проверьте Ваш заказ.<br>В настоящий момент в Вашей корзине следующие товары:
				</div>

				<table class="cart_2_table" cellpadding="0" cellspacing="0">
					<tr>
						<th id="ct_name">Наименование</th>
						<th>Цена за шт.</th>
						<th id="ct_amount">Количество</th>
					</tr>
					<?$this->registry['f_cart']->check_goods_table($total_goods_price);?>
				</table>

				<ul id="cart_2_total_goods_price">
					<li>
						<div class="c2tgp_val">
							<b><?=Common_Useful::price2read($total_goods_price);?></b> руб.
						</div>
						<div class="c2tgp_hint">
							Общая стоимость без учета скидки:
						</div>
						<div class="clr"></div>
					</li>

					<?$discount_amount = round($total_goods_price*$this->registry['userdata']['personal_discount']/100);?>

					<li>
						<div class="c2tgp_val">
							<b><?=$discount_amount;?></b> руб.
						</div>
						<div class="c2tgp_hint">
							Ваша скидка (<?=$this->registry['userdata']['personal_discount']?> %):
						</div>
						<div class="clr"></div>
					</li>

					<?$total_goods_price = $total_goods_price - $discount_amount;?>

					<li>
						<div class="c2tgp_val">
							<b><?=Common_Useful::price2read($total_goods_price);?></b> руб.
						</div>
						<div class="c2tgp_hint">
							Общая стоимость со скидкой:
						</div>
						<div class="clr"></div>
					</li>

					<?if($_POST['order_vals']['payment']==1):?>
					
						<?$diff = $total_goods_price*0.3;?>
					
						<li>
							<div class="c2tgp_val">
								<b><?=Common_Useful::price2read($diff);?></b> руб.
							</div>
							<div class="c2tgp_hint">
								Дополнительные расходы на доставку наложенным платежом
							</div>
							<div class="clr"></div>
						</li>
					<?else:?>
						<?$diff = 0;?>							
					<?endif;?>

					<li>
						<div class="c2tgp_val">
							<?if(($_POST['order_vals']['is_spb']==0 && $_POST['order_vals']['delivery']==2) || $_POST['order_vals']['delivery']==3 || ($_POST['order_vals']['delivery_costs']==0 && $_POST['order_vals']['delivery']!=2)):?>
								уточняется
							<?elseif($_POST['order_vals']['is_spb']==1 && $_POST['order_vals']['delivery']==2 && $_POST['order_vals']['delivery_costs']==0):?>
								бесплатна
							<?else:?>
								<b><?=Common_Useful::price2read(round($_POST['order_vals']['delivery_costs']));?></b> руб.
							<?endif;?>
						</div>
						<div class="c2tgp_hint">
							Стоимость доставки:
						</div>
						<div class="clr"></div>
					</li>
				</ul>

				<?$overall_price = $total_goods_price + $diff + round($_POST['order_vals']['delivery_costs']);?>
				<div id="cart_2_overall">
					Общая стоимость заказа составляет: <span><b><?=Common_Useful::price2read($overall_price);?></b> руб.</span>
				</div>

				<div class="clr"></div>

				<?if(isset($this->registry['ostatki_amount_hint'])):?>
					<div id="ostatki_amount_hint">
						<b style="color:#ff0000;">Внимание!</b><br>Добавленное в корзину количество следующих товаров больше, чем имеется на складе: <b><?=implode(', ',$this->registry['ostatki_amount_hint'])?></b>. Количество исправлено на максимально доступное к заказу.
					</div>
				<?endif;?>

				<?if(isset($_POST['order_vals']['payment']) && $_POST['order_vals']['payment']==1):?>
					<div id="percent_hint" class="margin_bot"><span>%</span>В случае заказа по предоплате <b>стоимость товара уменьшится на <?=PREPAY_DISCOUNT;?>%!</b></div>
				<?endif;?>

				<?if(isset($_POST['order_vals']['delivery']) && $_POST['order_vals']['delivery']==1 && $this->registry['is_spb']==1):?>
					<div class="common_hint margin_bot">
						Вы находитесь в Санкт-Петербурге. Значительно удобнее будет воспользоваться доставкой курьером. Стоимость курьерской доставки для  заказов на сумму более <b><?=FREE_DELIVERY_SUM;?></b> бесплатна. Вы можете вернуться назад и <a href="/cart/order/">указать другие параметры заказа</a>.
					</div>
				<?endif;?>

				<?if(isset($_POST['order_vals']['payment']) && $_POST['order_vals']['payment']==6 && $overall_price>$this->registry['userdata']['my_account']):?>
					<div class="common_hint">
						К сожалению, средств на вашем счету не хватает для оплаты заказа. Еще требуется <b><?=Common_Useful::price2read($overall_price-$this->registry['userdata']['my_account']);?></b> рублей. Выберите способ для оплаты их.

						<input type="hidden" name="order_vals[from_account]" value="<?=$this->registry['userdata']['my_account'];?>">

						<?$this->registry['f_cart']->print_payment_types_add();?>

					</div>
				<?endif;?>

				<div id="cart_2_params">

					<h2>Параметры заказа</h2>

					<ul class="cart_2_params_block">
						<li>
							<b>Выбранный способ оплаты:</b>
							<span><?=$this->registry['f_cart']->payment_types[$_POST['order_vals']['payment']]['name']?></span>
							<div class="clr"></div>
						</li>
						<li>
							<b>Выбранный способ доставки:</b>
							<span><?=$this->registry['f_cart']->delivery_types[$_POST['order_vals']['delivery']]['name']?></span>
							<div class="clr"></div>
						</li>
						<?if($_POST['order_vals']['delivery']==2):?>
						<li>
							<b>Контактный телефон:</b>
							<span><?=$_POST['phone'];?></span>
							<div class="clr"></div>
						</li>						
						<?endif;?>
						
					</ul>

					<div class="cart_2_params_hint">
						Проверьте еще раз реквизиты, по которым будет отправлен заказ:
					</div>

					<ul class="cart_2_params_block">
						<li>
							<b>Получатель:</b>
							<span><?=$this->registry['userdata']['name'];?></span>
							<div class="clr"></div>
						</li>
						<li>
							<b>Почтовый адрес:</b>
							<span><?=$this->registry['userdata']['zip_code'];?>, Россия, <?=$this->registry['userdata']['city'];?>, ул. <?=$this->registry['userdata']['street'];?>, д. <?=$this->registry['userdata']['house'];?><?= ($this->registry['userdata']['corpus']!='') ? ', корп. '.$this->registry['userdata']['corpus'] : '';?><?= ($this->registry['userdata']['flat']!='') ? ', кв. '.$this->registry['userdata']['flat'] : '';?> </span>
							<div class="clr"></div>
						</li>
						<li>
							<b>E-mail:</b>
							<span><?=$this->registry['userdata']['email'];?></span>
							<div class="clr"></div>
						</li>
					</ul>

				</div>

				<?if(!isset($this->registry['no_order_allowance'])):?>

					<div id="cart_submit">
						<input type="submit" value="Все правильно, заказать!">
					</div>

				<?endif;?>

				<div id="cart_alternative">
					или <a href="/cart/order/">указать другие параметры заказа</a>
				</div>

				<div class="clr"></div>

				<input type="hidden" name="order_vals[coupon]" value="<?=$_POST['order_vals']['coupon'];?>">
				<input type="hidden" name="order_vals[coupon_discount]" value="<?=$this->registry['coupon_discount'];?>">
				<input type="hidden" name="order_vals[wishes]" value="<?=htmlspecialchars($_POST['order_vals']['wishes']);?>">
				<input type="hidden" name="order_vals[delivery_type]" value="<?=$_POST['order_vals']['delivery'];?>">
				<input type="hidden" name="order_vals[delivery_costs]" value="<?=round($_POST['order_vals']['delivery_costs']);?>">
				<input type="hidden" name="order_vals[sum]" value="<?=$total_goods_price;?>">
				<input type="hidden" name="order_vals[overall_price]" value="<?=$overall_price;?>">
				<input type="hidden" name="order_vals[phone]" value="<?=$_POST['phone'];?>">

				<?if(!isset($this->registry['unset_prev_payment_method'])):?>
					<input type="hidden" name="order_vals[payment_method]" value="<?=$_POST['order_vals']['payment'];?>">
				<?endif;?>

			</form>

		<?endif;?>

	<?else:?>

		<div class="cart_hint">
			Произошла ошибка. <a href="http://www.bodybuilding-shop.ru/cart/order/">Вернитесь на предыдущий шаг</a> и повторите операцию снова.
		</div>

	<?endif;?>

</div>